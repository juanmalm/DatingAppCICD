steps:

- task: UseDotNet@2
  displayName: '[Test aceptación 1/8]: Instalar SDK .NET'
  inputs:
    packageType: 'sdk'
    version: '7.0.100'

# Descarga de artefactos
- task: DownloadPipelineArtifact@2
  displayName: '[Test aceptación 2/8]: Descarga artefacto Cliente'
  inputs:
    downloadPath: '$(Build.BinariesDirectory)'
    artifact: 'Cliente'

- task: DownloadPipelineArtifact@2
  displayName: '[Test aceptación 3/8]: Descarga artefacto API'
  inputs:
    downloadPath: '$(Build.BinariesDirectory)'
    artifact: 'API'

# Desempaquetar artefactos
- task: PowerShell@2
  displayName: '[Test aceptación 4/8]: Desempaquetar artefacto Cliente'
  inputs:
    targetType: 'inline'
    script: 'Expand-Archive $(Build.BinariesDirectory)/cliente.zip -DestinationPath $(Build.BinariesDirectory)/Cliente'

- task: PowerShell@2
  displayName: '[Test aceptación 5/8]: Desempaquetar artefacto API'
  inputs:
    targetType: 'inline'
    script: 'Expand-Archive $(Build.BinariesDirectory)/API.zip -DestinationPath $(Build.BinariesDirectory)/API'

# Ejecutar API
- task: PowerShell@2
  displayName: '[Test aceptación 6/8]: Ejecutar API'
  inputs:
    targetType: 'inline'
    script: 'Start-Job -ScriptBlock { $(Build.BinariesDirectory)/API/API.exe }'

# Ejecutar Cliente
- task: PowerShell@2
  displayName: '[Test aceptación 7/8]: Ejecutar Cliente'
  inputs:
    targetType: 'inline'
    script: |
      cd $(Build.BinariesDirectory)/Cliente
      npm install http-server -g
      Start-Job -ScriptBlock { http-server .\wwwroot\ }

# Smoke test
- task: PowerShell@2
  displayName: '[Test aceptación 8/9]: Smoke test'
  inputs:
    targetType: 'inline'
    script: 'Invoke-WebRequest -URI http://127.0.0.1:8080'

# Test unitarios
- task: DotNetCoreCLI@2
  displayName: '[Test aceptación 9/9]: Ejecución y publicación de los test'
  inputs:
    command: 'test'
    projects: 'API.AcceptanceTests/API.AcceptanceTests.csproj'