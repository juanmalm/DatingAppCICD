steps:

# Descarga de artefactos
- task: DownloadPipelineArtifact@2
  displayName: '[Empaquetado 1/3]: Descarga artefacto Cliente'
  inputs:
    downloadPath: '.azpipelines/packer/upload'
    artifact: 'Cliente'

- task: DownloadPipelineArtifact@2
  displayName: '[Empaquetado 2/3]: Descarga artefacto API'
  inputs:
    downloadPath: '.azpipelines/packer/upload'
    artifact: 'API'

- task: DownloadSecureFile@1
  displayName: 'Descarga appsettings.json de produccion'
  name: appsettings
  inputs:
    secureFile: 'appsettings.json'

- task: PowerShell@2
  displayName: 'Copia secure file en ruta final'
  inputs:
    targetType: 'inline'
    script: |
      cp $(appsettings.secureFilePath) .azpipelines/packer/upload/appsettings.json

# Crear imagen con Packer
- task: PackerBuild@1
  displayName: '[Empaquetado 3/3]: Crear imagen con Packer'
  inputs:
    templateType: 'custom'
    customTemplateLocation: '.azpipelines/packer/despliegue.json'
    customTemplateParameters: '{
      "SubscriptionId": "$(SubscriptionId)",
      "TenantId": "$(TenantId)",
      "ClientId": "$(ClientId)",
      "ClientSecret": "$(ClientSecret)",
      "ImageName": "DatingApp_$(Build.BuildNumber)",
      "ResourceGroupName": "$(ResourceGroupName)"}'